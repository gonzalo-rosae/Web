<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejercicios de Fonética Inglesa</title>
    <link rel="icon" href="../imagenes/favicon.ico" type="images/x-icon">
    <link rel="stylesheet" href="../estilos/general.css">
    <link rel="stylesheet" href="../estilos/test.css">
    <script src="../scripts/general.js"></script>
</head>

<body>
    <a id="flechaAtras" href="javascript:void(0);" onclick="window.history.back();">←</a>
    <div class="envoltura">
        <h1 id="titulo"></h1>
        <div id="instrucciones"></div>
        <div class="oculto" id="contenedorTest">
            <div id="estado"></div>
            <div id="pregunta"></div>
            <div id="alternativas"></div>
        </div>
        <button class="boton oculto" id="botonVolverEmpezar" onclick="volverEmpezarTest()">Otra vez</button>
        <button class="boton" id="botonEmpezar" onclick="empezarTest()">Empezar</button>
        <button class="boton oculto" id="botonSiguiente" onclick="siguientePregunta()">Siguiente</button>
    </div>

    <script>
        let preguntas = [];
        let indicePreguntaActual = 0;
        let cantidadRespuestasCorrectas = 0;

        async function cargarPreguntas() {
            const urlParams = new URLSearchParams(window.location.search);
            const nombreTest = urlParams.get('nombre');

            if (!nombreTest) {
                document.querySelector('.envoltura').innerHTML = '<p>Tipo de test no especificado.</p>';
                return;
            }

            try {
                const respuesta = await fetch(`../json/${nombreTest}.json`);
                if (!respuesta.ok) {
                    throw new Error('Error al cargar el archivo JSON');
                }
                const datos = await respuesta.json();

                if (datos.titulo) {
                    document.getElementById("titulo").textContent = datos.titulo;
                }
                if (datos.instrucciones) {
                    document.getElementById('instrucciones').textContent = datos.instrucciones;
                }
                if (datos.numRespuestas) {
                    document.getElementById("alternativas").className = "de" + datos.numRespuestas + "respuestas";
                }

                preguntas = datos.preguntas || [];
                mezclarArray(preguntas);

            } catch (error) {
                document.querySelector('.envoltura').innerHTML = `<p>Error al cargar el test: por favor, notifica a Gonzalo para que lo arregle.</p>`;
            }
        }

        function mezclarArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function cargarPregunta(indice) {
            const datosPregunta = preguntas[indice];
            const elementoPregunta = document.querySelector('#pregunta');
            const contenedorAlternativas = document.querySelector('#alternativas');
            contenedorAlternativas.innerHTML = ''; // Limpiar las alternativas anteriores

            // Configura la pregunta
            elementoPregunta.textContent = datosPregunta.pregunta;
            if (datosPregunta.pregunta.length < 4) elementoPregunta.classList.add('preguntaCorta');
            else elementoPregunta.classList.remove('preguntaCorta');

            // Desordena las opciones
            const opcionesDesordenadas = [...datosPregunta.opciones];
            mezclarArray(opcionesDesordenadas);

            // Encuentra el índice de la opción correcta (la primera en el array original)
            const opcionCorrecta = datosPregunta.opciones[0];
            const indiceCorrectoEnDesordenado = opcionesDesordenadas.indexOf(opcionCorrecta);

            // Crea las opciones dinámicamente
            opcionesDesordenadas.forEach((opcion, i) => {
                const elementoOpcion = document.createElement('div');
                elementoOpcion.className = 'opcion';
                elementoOpcion.textContent = opcion;
                elementoOpcion.onclick = () => verificarRespuesta(i);
                contenedorAlternativas.appendChild(elementoOpcion);
                elementoOpcion.dataset.indiceCorrecto = indiceCorrectoEnDesordenado;
            });

            actualizarEstado();
        }

        function verificarRespuesta(indiceSeleccionado) {
            const opciones = document.querySelectorAll('.opcion');
            let indiceCorrecto = null;

            // Encuentra el índice correcto en la lista actual
            opciones.forEach((opcion, i) => {
                if (opcion.textContent === preguntas[indicePreguntaActual].opciones[0]) {
                    indiceCorrecto = i;
                }
            });

            opciones.forEach((opcion, i) => {
                opcion.classList.remove('correcto', 'incorrecto');
                // Desactivar clics después de la selección
                opcion.style.pointerEvents = 'none';
                if (i === indiceCorrecto) {
                    opcion.classList.add('correcto');
                    if (i === indiceSeleccionado) {
                        cantidadRespuestasCorrectas++;
                    }
                } else if (i === indiceSeleccionado) {
                    opcion.classList.add('incorrecto');
                }
            });

            document.getElementById('botonSiguiente').classList.remove('oculto');
        }

        function siguientePregunta() {
            const esUltimaPregunta = indicePreguntaActual === preguntas.length - 1;
            if (esUltimaPregunta) {
                mostrarResultados();
            } else {
                indicePreguntaActual++;
                cargarPregunta(indicePreguntaActual);
            }

            document.getElementById('botonSiguiente').classList.add('oculto');
        }

        function empezarTest() {
            document.getElementById('titulo').classList.add('oculto');
            document.getElementById('botonEmpezar').classList.add('oculto');
            document.getElementById('instrucciones').classList.add('oculto');
            document.getElementById('contenedorTest').classList.remove('oculto');
            cargarPregunta(indicePreguntaActual);
        }

        function volverEmpezarTest() {
            indicePreguntaActual = 0;
            cantidadRespuestasCorrectas = 0;

            const contenedorTest = document.getElementById('contenedorTest');
            contenedorTest.innerHTML = '';

            const estado = document.createElement('div');
            estado.id = 'estado';
            contenedorTest.appendChild(estado);

            const pregunta = document.createElement('div');
            pregunta.id = 'pregunta';
            contenedorTest.appendChild(pregunta);

            const alternativas = document.createElement('div');
            alternativas.id = 'alternativas';
            contenedorTest.appendChild(alternativas);

            cargarPreguntas().then(() => {
                cargarPregunta(indicePreguntaActual);
                document.getElementById('botonVolverEmpezar').classList.add('oculto');
                document.getElementById('botonSiguiente').classList.add('oculto');
            });
        }

        function mostrarResultados() {
            const contenedorTest = document.getElementById('contenedorTest');
            contenedorTest.innerHTML = `<div class="resultado">Has acertado ${cantidadRespuestasCorrectas} de ${preguntas.length} preguntas</div>`;
            document.getElementById('botonSiguiente').classList.add('oculto');
            document.getElementById('botonVolverEmpezar').classList.remove('oculto');
        }

        function actualizarEstado() {
            document.getElementById('estado').textContent = `${indicePreguntaActual + 1}/${preguntas.length}`;
        }

        cargarPreguntas();
    </script>

</body>

</html>